---
layout: post
title:  欧式空间上LSH(1)--误差分析
categories: [probability]
---

最近几天中秋节休假，终于有时间可以好好研究欧式空间的LSH(Locality Sensitive Hashing)的误差。基于欧式空间LSH接下来会发表一些列博文，描述细节和相关实践，本博文描述个人认为最重要也是最难啃的误差分析（本人数学能力有限，大神请忽略）。

## LSH做什么

LSH主要是一种最近邻居的估算方法，主要思路是设计一些hash函数，将那些比较类似的对象hash到一个单位，距离较大的hash到不同的单位里。hash过程相当于一种过滤机制，缩小检索范围。最近邻居蛮力计算方法需要的时间复杂度$O(n^2)$，而使用设计良好的LSH，可以在保证错误率很低的情况下，时间复杂度降到$O(n)$，在一些不需要准确最近邻居的应用场景，可以大规模应用。本人工作中，此类场景比较多，这也是为什么值得花时间研究该技术的主要动力。


## 欧式空间的LSH

LSH的技术比较成熟，应用最多还是在集合上，结合minhash算法，得到漂亮的理论推导和不错应用效果。但是本人工作的应用场景中，主要的数据对象比较适合在欧式空间中，所以本系列博文着重介绍欧式空间的LSH相关的内容。欧式空间中，LSH的hash算法的思路是将n维向量随机射到一个向量，使用向量点乘，由于投射向量不是单位向量，所以严格意义上不能称之为投影。投射完后，需要设置一个固定长度为$w$的参数，将向量严格的划分为不同的单位，投射到相同单位的向量就认为比较近。所以，$w$的设置十分重要，如果设置太大，比较远的对象也设hash到一个单位里，无法做到过滤的效果；如果太小，即使很近的对象也到不了一个桶里面，导致找不到相领的对象。

## 概率分析

设向量$p,q \in R^n$，并且$u=||p-q||_2$，p与q投射到任意向量$a$的概率如下，

$$
	p(u) = Pr(h(p) = h(q)) = 2*\int_{0}^{w}\frac{1}{u}f(\frac{t}{u})(1-\frac{t}{w})dt
$$

上面概率公式很突然但是也很优美，先别慌是怎么过来的，后面慢慢道来，我们先直奔主题，如何计算该概率，这样就可以适当的配置概率，控制误差。公式中$f(x)=\frac{1}{\sqrt{2\pi}}e^{-\frac{x^2}{2}}$是标准正在分布概率密度函数。


$$
\begin{align}
	p(u) = f(u,w) &= 2(\int_{0}^{w}\frac{1}{u}f(\frac{t}{u})dt - \int_{0}^{w}\frac{1}{u}f(\frac{t}{u})\frac{t}{w}dt) \\
				  &= 2(\int_{0}^{w}f(\frac{t}{u})d\frac{t}{u} - \int_{0}^{w}\frac{1}{u\sqrt{2\pi}}e^{-\frac{t^2}{2u^2}}\frac{t}{w}dt) \\
				  &= 2(\int_{0}^{\frac{w}{u}}f(x)dx - \frac{-u}{\sqrt{2\pi}w}\int_{0}^{w}e^{-\frac{t^2}{2u^2}}d(-\frac{t^2}{2u^2})) \\
				  &= 2(\frac{1}{2} - F(-\frac{w}{u}) + \frac{u}{\sqrt{2\pi}w}e^{-\frac{t^2}{2u^2}}|^w_0) \\
				  &= 2(\frac{1}{2} - F(-\frac{w}{u}) + \frac{u}{\sqrt{2\pi}w}(e^{-\frac{w^2}{2u^2}}-1)) \\
				  &= 1 - 2F(-\frac{1}{c}) + \frac{2c}{\sqrt{2\pi}}(e^{-\frac{1}{2c^2}}-1)
		 
\end{align}
$$
 
上面的概率只与$u$，$w$的比例有关，令$c=\frac{u}{w}$，
 
$$
	g(c) = 1 - 2F(-\frac{1}{c}) + \frac{2c}{\sqrt{2\pi}}(e^{-\frac{1}{2c^2}}-1) 
$$

根据曲线，上述函数使个减函数，也就是距离越大，聚到一起的概率月底，可以通过设定u，然后通过曲线，得到对应w。

$$
	\begin{align}
		g\prime(c) &= -2f(-\frac{1}{c})(-1)(-1)c^{-2} + \sqrt{\frac{2}{\pi}}(e^{-\frac{1}{2c^2}}-1) + \sqrt{\frac{2}{\pi}}c(e^{-\frac{1}{2c^2}}(-\frac{1}{2})(-2)c^{-3}) \\
				   &= -\frac{2}{c^2}f(-\frac{1}{c}) + \sqrt{\frac{2}{\pi}}(e^{-\frac{1}{2c^2}}-1) + \sqrt{\frac{2}{\pi}}e^{-\frac{1}{2c^2}}c^{-2} \\
				   &= -\frac{2}{c^2}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2c^2}} + \sqrt{\frac{2}{\pi}}(e^{-\frac{1}{2c^2}}-1) + \sqrt{\frac{2}{\pi}}e^{-\frac{1}{2c^2}}c^{-2} \\
				   &= \sqrt{\frac{2}{\pi}}(e^{-\frac{1}{2c^2}}-1) < 0
	\end{align}
$$

